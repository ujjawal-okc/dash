name: Build and Deploy

on:
  issues:
    types:
      - opened
  pull_request:
    branches:
      - master
      - release/**
    types:
      - opened
      - synchronize
      - closed
  push:
    branches:
      - master
      - release/**

env:
  GITHUB_REPO: ${{ github.event.repository.name }}
  GITHUB_EVENT: ${{ github.event_name }}
  GITHUB_REF: ${{ github.ref }}
  GITHUB_HEAD_REF: ${{ github.head_ref }}
  GITHUB_BASE_REF: ${{ github.base_ref }}
  GITHUB_WORKSPACE: ${{ github.workspace }}
  GITHUB_ACTION: ${{ github.action }}
  
jobs:
  setup-build-publish-deploy:
    name: Setup, Build, Publish, and Deploy
    runs-on: ubuntu-18.04
      
    steps:
    - name: Environment
      #if: startsWith(github.event.issue.title, 'deploy')
      run: |
        #echo "::set-env name=TAG::${GITHUB_SHA::8}"
        echo ${{ env.TAG }}
        echo ${{ github.event.action }}

    - name: Checkout
      if: env.TAG && env.TAG
      uses: actions/checkout@v2
      with:
        ref: ${{ env.GIT_BRANCH }}
        path: main
        
    - name: Docker Build
      uses: docker/build-push-action@v1
      with:
        username: _json_key
        password: ${{ secrets.TOKEN }}
        registry: gcr.io
        repository: nginx
        dockerfile: Dockerfile
        tag_with_sha: true
        build_args: SSH_PRIVATE_KEY=${{ secrets.SSH_KEY }}
        
    - name: Checkout Ops
      uses: actions/checkout@v2
      env:
        SSH_KEY: ${{ steps.ssh.outputs.ssh_key }}
      with:
        repository: ${{ format('{0}-ops', github.repository) }}
        token: ${{ secrets.TOKEN }}
        path: ops

